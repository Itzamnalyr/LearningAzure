{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceGroupLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    }
  },
  "variables": {
  },
  "resources": [
    {
      "name": "[variables('applicationInsightsName')]",
      "type": "Microsoft.Insights/components",
      "location": "[resourceGroup().location]",
      "apiVersion": "2014-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('webSiteName'))]"
      ],
      "tags": {
        "displayName": "Application Insights"
      },
      "properties": {
        "applicationId": "[resourceId('Microsoft.Web/sites', variables('webSiteName'))]"
      }
    },
    {
      "type": "microsoft.insights/actionGroups",
      "apiVersion": "2018-09-01",
      "name": "[variables('actionGroupName')]",
      "location": "global",
      "tags": {
        "displayName": "Action Group"
      },
      "properties": {
        "groupShortName": "[variables('actionGroupShortName')]",
        "enabled": true,
        "emailReceivers": [
          {
            "name": "[concat(parameters('appPrefix'), ' dev team')]",
            "emailAddress": "[parameters('alertEmailAddress')]"
          }
        ],
        "smsReceivers": [],
        "webhookReceivers": [],
        "itsmReceivers": [],
        "azureAppPushReceivers": [],
        "automationRunbookReceivers": [],
        "voiceReceivers": [],
        "logicAppReceivers": [],
        "azureFunctionReceivers": []
      }
    },
    {
      "type": "microsoft.insights/webtests",
      "apiVersion": "2015-05-01",
      "name": "[variables('applicationInsightsAvailablityTestName')]",
      "location": "eastus",
      "tags": {
        "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.insights/components/', variables('applicationInsightsName'))]": "Resource",
        "displayName": "Availability web test"
      },
      "properties": {
        "SyntheticMonitorId": "[variables('applicationInsightsAvailablityTestName')]",
        "Name": "Home page test",
        "Enabled": true,
        "Frequency": 300,
        "Timeout": 120,
        "Kind": "ping",
        "RetryEnabled": true,
        "Locations": [
          {
            "Id": "us-ca-sjc-azr"
          },
          {
            "Id": "us-tx-sn1-azr"
          },
          {
            "Id": "us-il-ch1-azr"
          },
          {
            "Id": "us-va-ash-azr"
          },
          {
            "Id": "us-fl-mia-edge"
          }
        ],
        "Configuration": {
          "WebTest": "[concat('<WebTest Name=\"Home page test\" Id=\"c960ac1f-b7a1-4a0b-9aa9-33048f24dfe4\" Enabled=\"True\" CssProjectStructure=\"\" CssIteration=\"\" Timeout=\"120\" WorkItemIds=\"\" xmlns=\"http://microsoft.com/schemas/VisualStudio/TeamTest/2010\" Description=\"\" CredentialUserName=\"\" CredentialPassword=\"\" PreAuthenticate=\"True\" Proxy=\"default\" StopOnError=\"False\" RecordedResultFile=\"\" ResultsLocale=\"\"><Items><Request Method=\"GET\" Guid=\"a0814d09-f8e5-28ff-d6b3-2b632e291eeb\" Version=\"1.1\" Url=\"https://', parameters('websiteDomainName'), '\" ThinkTime=\"0\" Timeout=\"120\" ParseDependentRequests=\"False\" FollowRedirects=\"True\" RecordResult=\"True\" Cache=\"False\" ResponseTimeGoal=\"0\" Encoding=\"utf-8\" ExpectedHttpStatusCode=\"200\" ExpectedResponseUrl=\"\" ReportingName=\"\" IgnoreHttpStatusCode=\"False\" /></Items></WebTest>')]"
        }
      }
    },
    {
      "type": "microsoft.insights/metricalerts",
      "apiVersion": "2018-03-01",
      "name": "[variables('applicationInsightsAvailablityTestName')]",
      "location": "global",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('applicationInsightsName'))]",
        "[resourceId('microsoft.insights/webtests', variables('applicationInsightsAvailablityTestName'))]"
      ],
      "tags": {
        "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.insights/components/', variables('applicationInsightsName'))]": "Resource",
        "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.insights/webtests/', variables('applicationInsightsAvailablityTestName'))]": "Resource",
        "displayName": "Availability alert"
      },
      "properties": {
        "description": "[concat('Created alert rule for availability test \"', variables('applicationInsightsAvailablityTestName'), '\"')]",
        "severity": 1,
        "enabled": true,
        "scopes": [
          "[resourceId('microsoft.insights/components', variables('applicationInsightsName'))]",
          "[resourceId('microsoft.insights/webtests', variables('applicationInsightsAvailablityTestName'))]"
        ],
        "evaluationFrequency": "PT1M",
        "windowSize": "PT5M",
        "templateType": 8,
        "criteria": {
          "componentId": "[resourceId('microsoft.insights/components', variables('applicationInsightsName'))]",
          "failedLocationCount": 2,
          "odata.type": "Microsoft.Azure.Monitor.WebtestLocationAvailabilityCriteria",
          "webTestId": "[resourceId('microsoft.insights/webtests', variables('applicationInsightsAvailablityTestName'))]"
        },
        "actions": []
      }
    }

  ],
  "outputs": {
  }
}
